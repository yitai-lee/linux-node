# Linux 容器與虛擬化相關技術筆記

## 一、Linux 使用 Namespace 隔離與 cgroups 限制做資源管理

### Namespace（命名空間）
- 提供資源的「視角**隔離**」，讓每個容器或程序有獨立的資源觀察範圍，如獨立的進程號（PID）、網路介面（NET）、掛載點（MNT）等，互相隔離看不到對方。

### cgroups（控制群組）
- 用於**限制**和管理系統資源（CPU、記憶體、磁碟 I/O 等）使用量，確保容器或程序不會占用超過配置的資源，避免單一容器資源暴走影響整體系統。

## 二、VM（虛擬機）與容器差異

| 項目       | VM (虛擬機)                              | 容器                                    |
|------------|----------------------------------------|-----------------------------------------|
| 核心概念   | **模擬完整硬體環境**，包含 CPU、記憶體等   | **共用宿主機 OS 核心**，只隔離使用者空間與資源 |
| 系統組成   | 完整客戶作業系統（含 Kernel）          | 只有使用者空間，Kernel 與宿主共用         |
| 安全性     | **高**，因獨立 Kernel                      | 較**低**，Kernel 漏洞可能導致容器逃逸         |
| 資源消耗   | 大                                     | 輕量，快速啟動                          |
| **root 權限影響** | 容器 **內 root 影響限於 VM**              | 容器內 **root 權限可能直接危害宿主機安全**   |

## 三、Docker 與 Podman 差異

| 項目       | Docker                          | Podman                        |
|------------|--------------------------------|------------------------------|
| 架構       | 有常駐守護進程（dockerd）       | 無守護進程，daemonless       |
| 容器管理   | 透過 dockerd 管理容器           | 每個容器獨立運行              |
| 預設權限   | 預設以 root 身份執行            | 支援 rootless 模式            |
| 重啟機制   | 支援 --restart 自動重啟         | 有預設守護進程可以開啟podman-restart.service ，也可以另外搭配 systemd restart  |
| 安全性     | root 權限較高                  | rootless 減少攻擊面，較安全  |

## 四、Docker 與 Podman 容器重啟差異

- **Docker**：守護進程 dockerd 支援 `--restart` 參數，daemon 重啟或宿主機重啟會自動重啟容器。
- **Podman**：可以開啟podman-restart.service 。或是可用 `podman generate systemd` 生成 systemd 服務單元，交由 systemd 管理。
![podman-restart.service](image/docker/podman-restart-service.png "podman-restart.service")
## 五、Kubernetes（K8s）中 Root 權限與 User Namespace 隔離

- 預設容器以 root 身份運行，風險較高。
- K8s 1.33 起，預設啟用 User Namespace 隔離（`hostUsers: false`），將容器 root UID 映射成宿主機非 root 用戶，降低風險。
- 需 Linux Kernel ≥6.3，容器 runtime 與檔案系統支援。

Reference:  
[Securing Kubernetes 1.33 Pods: The Impact of User Namespace Isolation](https://www.cncf.io/blog/2025/07/16/securing-kubernetes-1-33-pods-the-impact-of-user-namespace-isolation/)



---

## 總結

| 主題                     | 核心重點                                         |
|--------------------------|------------------------------------------------|
| Namespace + cgroups       | Namespace 隔離資源視角，cgroups 限制資源量         |
| VM vs 容器               | VM 獨立 kernel 高安全但重資源，容器輕量但風險高     |
| Docker vs Podman          | Docker 有守護進程，Podman 無守護進程且支援 rootless |
| 容器重啟                 | Docker 支援自動重啟，Podman 要開啟podman-restart.service或systemd 管理          |
| K8s rootless             | 1.33 版起預設 User Namespace 隔離降低 root 風險      |
| Podman 與 systemd / Quadlet | systemd 管理生命週期，Quadlet 用 YAML 簡化配置      |








## 六 Docker Overlay 網路完整筆記

## 一、Overlay 是什麼
Overlay 是 Docker 或 Kubernetes 用來讓「不同主機的容器能互通」的虛擬網路。  
它會在多台主機之間建立 VXLAN（或 Geneve）隧道，把容器封包封起來再送到對方主機，  
讓不同主機的容器看起來像在同一個內網。

---

## 二、容器內的網路介面與 IP
在 Overlay 網路中，每個容器通常會有兩張虛擬網卡（eth0、eth1）：

| 介面名稱 | 網段範例 | 來源網路 | 功能說明 |
|-----------|-----------|-----------|-----------|
| **eth0** | 10.0.x.x | overlay（如 elk-net） | 用於跨主機容器之間的內部通訊 |
| **eth1** | 172.18.x.x | docker_gwbridge | 用於對外連線（上網或與主機互通） |

---

## 三、Overlay 與 Bridge 的差別與關係
| 類型 | 範圍 | 功能 | 是否跨主機 |
|------|------|------|-------------|
| **Bridge** | 單一主機 | 容器共享主機的虛擬交換器（docker0） | 否 |
| **Overlay** | 多主機 | 建立跨主機虛擬網路（VXLAN 封裝） | 是 |
| **docker_gwbridge** | 單一主機出口 | 讓 overlay 容器能連外 | 否 |

**重點：**
- Overlay：負責「容器 ↔ 容器（跨主機）」的內部封包。  
- Bridge / gwbridge：負責「容器 ↔ 外部世界」的出口封包。

---

## 四、封包實際路徑解析

### 1️⃣ 容器與容器之間（跨主機）

[容器A eth0:10.0.2.8]  
↓  
Overlay VXLAN 封裝 (eth0)  
↓  
[Node1 實體網卡]  
↓  
[Node2 實體網卡]  
↓  
Overlay VXLAN 解封  
↓  
[容器B eth0:10.0.2.9]

此時封包只在 overlay 網路內部傳遞，不會經過外部網路。

---

### 2️⃣ 容器對外連線（上網或連主機）

[容器 eth1:172.18.0.3]  
↓  
docker_gwbridge（主機內 bridge）  
↓  
主機實體網卡 (eth0)  
↓  
外部網路 / Internet

---

## 、整體結構示意圖
```
Overlay Network (VXLAN)
┌────────────────────────────────────────────┐
│                10.0.2.0/24                │
│                                            │
│ [Node1]                           [Node2]  │
│  ┌────────────────┐          ┌────────────────┐
│  │容器A eth0→10.0.2.8 ─── eth0←10.0.2.9 容器B│
│  │容器A eth1→172.18.0.3  eth1→172.18.0.4 容器B│
│  └────────────────┘          └────────────────┘
│         │                           │
│   docker_gwbridge            docker_gwbridge
│         │                           │
│      主機網卡                    主機網卡
│         │                           │
└─────────┴────────────── Internet ─────┘
```
---

## 六、口語化理解
- 每台主機像一棟大樓，裡面的容器用 bridge 互通（同棟樓住戶）。  
- Overlay 就像在不同大樓之間拉光纖（VXLAN），讓住戶能跨樓通話。  
- docker_gwbridge 是大樓的網路出口，讓人能上網或打外線電話。

---

## 七、重點整理
1. Overlay：讓容器跨主機互通。  
2. gwbridge：讓 overlay 容器能連外。  
3. 容器同時會有兩張網卡：  
   - `eth0` → Overlay（內部互通）  
   - `eth1` → gwbridge（外部連線）  
4. Overlay 是內部虛擬網路，不代表能直接上網，  
   要連外需透過 bridge（docker_gwbridge）出口。
```
```
bridge：同主機容器互通  
overlay：跨主機容器互通  
docker_gwbridge：容器對外通訊出口
```