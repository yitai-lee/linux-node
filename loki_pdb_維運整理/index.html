<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>loki_pdb_維運整理 - Darren</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "loki_pdb_\u7dad\u904b\u6574\u7406";
        var mkdocs_page_input_path = "loki_pdb_\u7dad\u904b\u6574\u7406.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../image/favicon.ico" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../note/">使用 MkDocs 建立文件網站教學筆記</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../%E5%AE%B9%E5%99%A8%E7%9F%A5%E8%AD%98/">Linux 容器筆記</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../docker_commands/">Docker常用命令</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ansible%E7%B0%A1%E4%BB%8B%E5%8F%8A%E7%94%A8%E6%B3%95/">Ansible簡介及用法</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../%E9%81%8B%E7%B6%AD%E7%9F%A5%E8%AD%98/">運維知識</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator%E4%BB%8B%E7%B4%B9/">operator介紹</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ocp%E5%91%BD%E4%BB%A4/">ocp命令</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ocp-prot%E4%BB%8B%E7%B4%B9/">ocp-prot介紹</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">loki_pdb_維運整理</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#1">1. 問題背景（你實際遇到的狀況）</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2-pdb">2. PDB 三個關鍵欄位的「實際意思」（口語化）</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#21-minavailable">2.1 minAvailable</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#22-maxunavailable">2.2 maxUnavailable</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#23-allowed-disruptions">2.3 ALLOWED DISRUPTIONS</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#3-loki">3. 為什麼 Loki 會「全部卡死」</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4-pdb">4. 你實際觀察到的「PDB 行為變化」（關鍵證據）</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#5-patch-minavailable-0">5. 為什麼「patch minAvailable = 0」不是永久解法</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#51">5.1 你已實測到的事實</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#52">5.2 結論（只根據你提供的證據）</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#6">6. 正確的實務處理策略（依目的區分）</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#61-drain">6.1 目的一：讓升級 / drain 不要卡住（短期）</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#62">6.2 升級完成後（必要復原）</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#7-pdb">7. 快速檢查「哪些 PDB 正在擋你」的標準指令</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#71-disruptionsallowed-0">7.1 列出 disruptionsAllowed = 0（你已驗證可用）</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#72">7.2 含表頭版本（你實際需要的格式）</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#8-deployment">8. 關於「直接改 Deployment 副本數」為什麼不可靠</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#9">9. 若要「真正長期解決」的方向（不給未驗證命令）</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#10">10. 一句話總結（完全對應你的實測）</a>
    </li>
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Darren</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">loki_pdb_維運整理</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="loki-pdb">Loki 與 PDB 升級衝突處理與維運手冊</h1>
<blockquote>
<p>本文件<strong>僅整理與歸納使用者實際提供的文獻、指令輸出與實測行為</strong>，不引入任何未出現在對話中的假設或外部推論。</p>
</blockquote>
<hr />
<h2 id="1">1. 問題背景（你實際遇到的狀況）</h2>
<p>在 <code>openshift-logging</code> namespace 中，LokiStack 各元件存在以下狀態：</p>
<ul>
<li>多數 Loki 元件 <strong>只有 1 個 Pod 副本</strong></li>
<li>對應的 <strong>PodDisruptionBudget (PDB)</strong> 全部設定：</li>
<li><code>minAvailable: 1</code></li>
<li><code>ALLOWED DISRUPTIONS: 0</code></li>
</ul>
<p>代表結果：</p>
<blockquote>
<p><strong>任何 eviction（包含 node drain、升級過程的自願驅逐）都會被 PDB 阻擋</strong>。</p>
</blockquote>
<p>這正是你在升級 / 節點維護時，節點卡住、流程無法繼續的直接原因。</p>
<hr />
<h2 id="2-pdb">2. PDB 三個關鍵欄位的「實際意思」（口語化）</h2>
<h3 id="21-minavailable">2.1 minAvailable</h3>
<ul>
<li>定義：<strong>至少必須保持多少個「健康 Pod」</strong></li>
<li>你看到的設定：</li>
</ul>
<pre><code class="language-yaml">spec:
  minAvailable: 1
</code></pre>
<p>白話翻譯：</p>
<blockquote>
<p>「不管發生什麼事，至少要有 1 個 Pod 活著。」</p>
</blockquote>
<p>當副本數 = 1 時，這個設定代表：</p>
<blockquote>
<p><strong>那唯一的一個 Pod 絕對不能被趕走</strong>。</p>
</blockquote>
<hr />
<h3 id="22-maxunavailable">2.2 maxUnavailable</h3>
<ul>
<li>定義：<strong>最多允許多少個 Pod 不可用</strong></li>
<li>你目前的 Loki PDB <strong>沒有使用這個欄位</strong>，因此顯示 <code>N/A</code></li>
<li>PDB 設計上：<code>minAvailable</code> 與 <code>maxUnavailable</code> <strong>只能擇一</strong></li>
</ul>
<hr />
<h3 id="23-allowed-disruptions">2.3 ALLOWED DISRUPTIONS</h3>
<ul>
<li>這不是你設定的值</li>
<li>是 Kubernetes 根據「目前 Pod 狀態 + PDB spec」<strong>即時計算的結果</strong></li>
</ul>
<p>你實測與驗證：</p>
<pre><code class="language-bash">oc get pdb lokistack-distributor -n openshift-logging \
  -o jsonpath='{.status.disruptionsAllowed}'
</code></pre>
<p>當值為 <code>0</code> 時，意義非常明確：</p>
<blockquote>
<p><strong>現在不允許任何 eviction 發生</strong>。</p>
</blockquote>
<hr />
<h2 id="3-loki">3. 為什麼 Loki 會「全部卡死」</h2>
<p>條件組合如下：</p>
<ul>
<li>Pod 副本數 = 1</li>
<li>PDB <code>minAvailable = 1</code></li>
</ul>
<p>推論結果（你已實際驗證）：</p>
<pre><code>ALLOWED DISRUPTIONS = currentHealthy - minAvailable
                      = 1 - 1
                      = 0
</code></pre>
<p>因此：</p>
<blockquote>
<p><strong>只要 drain 節點時碰到這顆 Pod，就一定會被擋。</strong></p>
</blockquote>
<hr />
<h2 id="4-pdb">4. 你實際觀察到的「PDB 行為變化」（關鍵證據）</h2>
<p>你使用以下方式進行即時監控：</p>
<pre><code class="language-bash">oc get pdb lokistack-distributor -n openshift-logging -w \
  -o jsonpath='{.metadata.resourceVersion}\t{.spec.minAvailable}\t{.status.disruptionsAllowed}\n'
</code></pre>
<p>觀察到的實際輸出順序（重點）：</p>
<pre><code>42818601   1   0
42823866   0   0
42823869   0   1
42823878   1   1
42823879   1   0
</code></pre>
<p>這證明了以下事實：</p>
<ol>
<li><code>minAvailable</code> 被 patch 成 <code>0</code> 後</li>
<li><code>disruptionsAllowed</code> <strong>確實會短暫變成 &gt; 0</strong></li>
<li>後續又被改回 <code>minAvailable = 1</code></li>
</ol>
<blockquote>
<p><strong>PDB 不是靜態的，它會被系統重新調整。</strong></p>
</blockquote>
<hr />
<h2 id="5-patch-minavailable-0">5. 為什麼「patch minAvailable = 0」不是永久解法</h2>
<h3 id="51">5.1 你已實測到的事實</h3>
<ul>
<li><code>oc patch pdb ... minAvailable=0</code> <strong>可以生效</strong></li>
<li>但之後 <code>resourceVersion</code> 再次變動</li>
<li><code>minAvailable</code> 被改回 <code>1</code></li>
</ul>
<p>這代表：</p>
<blockquote>
<p><strong>PDB 受 Operator / 控制器 reconcile 行為影響</strong>。</p>
</blockquote>
<hr />
<h3 id="52">5.2 結論（只根據你提供的證據）</h3>
<ul>
<li><code>minAvailable=0</code> <strong>只能當作「維護 / 升級期間的暫時手段」</strong></li>
<li>不能當成永久設定依賴</li>
</ul>
<hr />
<h2 id="6">6. 正確的實務處理策略（依目的區分）</h2>
<h3 id="61-drain">6.1 目的一：讓升級 / drain 不要卡住（短期）</h3>
<p><strong>你實際可行、且已驗證的方法：</strong></p>
<pre><code class="language-bash">oc patch pdb lokistack-distributor      -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:0}}'
oc patch pdb lokistack-index-gateway    -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:0}}'
oc patch pdb lokistack-ingester         -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:0}}'
oc patch pdb lokistack-querier          -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:0}}'
oc patch pdb lokistack-query-frontend   -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:0}}'
</code></pre>
<p>用途：</p>
<blockquote>
<p><strong>只為了讓 eviction 能走得動，完成升級或節點維護。</strong></p>
</blockquote>
<hr />
<h3 id="62">6.2 升級完成後（必要復原）</h3>
<pre><code class="language-bash">oc patch pdb lokistack-distributor      -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:1}}'
oc patch pdb lokistack-index-gateway    -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:1}}'
oc patch pdb lokistack-ingester         -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:1}}'
oc patch pdb lokistack-querier          -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:1}}'
oc patch pdb lokistack-query-frontend   -n openshift-logging --type=merge -p '{&quot;spec&quot;:{&quot;minAvailable&quot;:1}}'
</code></pre>
<p>原因：</p>
<blockquote>
<p><strong>否則 Loki 在日常運作時將完全失去可用性保護。</strong></p>
</blockquote>
<hr />
<h2 id="7-pdb">7. 快速檢查「哪些 PDB 正在擋你」的標準指令</h2>
<h3 id="71-disruptionsallowed-0">7.1 列出 disruptionsAllowed = 0（你已驗證可用）</h3>
<pre><code class="language-bash">oc get pdb -A -o jsonpath='{range .items[?(@.status.disruptionsAllowed==0)]}{.metadata.namespace}{&quot;\t&quot;}{.metadata.name}{&quot;\n&quot;}{end}'
</code></pre>
<h3 id="72">7.2 含表頭版本（你實際需要的格式）</h3>
<pre><code class="language-bash">{
  printf &quot;NAMESPACE\tNAME\tALLOWED_DISRUPTIONS\n&quot;
  oc get pdb -A -o jsonpath='{range .items[?(@.status.disruptionsAllowed==0)]}{.metadata.namespace}{&quot;\t&quot;}{.metadata.name}{&quot;\t&quot;}{.status.disruptionsAllowed}{&quot;\n&quot;}{end}'
} | column -t
</code></pre>
<hr />
<h2 id="8-deployment">8. 關於「直接改 Deployment 副本數」為什麼不可靠</h2>
<p>你已實測：</p>
<pre><code class="language-bash">oc patch deploy lokistack-distributor -n openshift-logging -p '{&quot;spec&quot;:{&quot;replicas&quot;:2}}'
</code></pre>
<p>結果：</p>
<ul>
<li>Replica 短暫變成 2</li>
<li>隨即被改回 1</li>
</ul>
<p>結論（根據你的實測）：</p>
<blockquote>
<p><strong>LokiStack 屬於 Operator 管理資源，Deployment 不是最終真實來源。</strong></p>
</blockquote>
<hr />
<h2 id="9">9. 若要「真正長期解決」的方向（不給未驗證命令）</h2>
<p>唯一合理方向：</p>
<blockquote>
<p><strong>從 LokiStack CR 本身調整 size / 架構，讓元件天生具備多副本。</strong></p>
</blockquote>
<p>但：</p>
<ul>
<li>你未提供完整 <code>LokiStack</code> CR YAML</li>
<li>因此此文件 <strong>不給任何推測性設定值</strong></li>
</ul>
<hr />
<h2 id="10">10. 一句話總結（完全對應你的實測）</h2>
<blockquote>
<p><strong>Loki 不是不能升級，是 PDB + 單副本設計讓 eviction 無法發生。</strong><br />
<strong>patch minAvailable=0 是維護開關，不是永久設定。</strong></p>
</blockquote>
<hr />
<p>（本文件結束）</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ocp-prot%E4%BB%8B%E7%B4%B9/" class="btn btn-neutral float-left" title="ocp-prot介紹"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ocp-prot%E4%BB%8B%E7%B4%B9/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
