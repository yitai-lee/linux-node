<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Linux 容器筆記 - Darren</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Linux \u5bb9\u5668\u7b46\u8a18";
        var mkdocs_page_input_path = "\u5bb9\u5668\u77e5\u8b58.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../image/favicon.ico" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../note/">使用 MkDocs 建立文件網站教學筆記</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Linux 容器筆記</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#linux-namespace-cgroups">一、Linux 使用 Namespace 隔離與 cgroups 限制做資源管理</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#namespace">Namespace（命名空間）</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cgroups">cgroups（控制群組）</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vm">二、VM（虛擬機）與容器差異</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#docker-podman">三、Docker 與 Podman 差異</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#docker-podman_1">四、Docker 與 Podman 容器重啟差異</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#kubernetesk8s-root-user-namespace">五、Kubernetes（K8s）中 Root 權限與 User Namespace 隔離</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_1">總結</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#docker-overlay">六 Docker Overlay 網路完整筆記</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#overlay">一、Overlay 是什麼</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ip">二、容器內的網路介面與 IP</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#overlay-bridge">三、Overlay 與 Bridge 的差別與關係</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_2">四、封包實際路徑解析</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1">1️⃣ 容器與容器之間（跨主機）</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2">2️⃣ 容器對外連線（上網或連主機）</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">、整體結構示意圖</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_4">六、口語化理解</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_5">七、重點整理</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../docker_commands/">Docker常用命令</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ansible%E7%B0%A1%E4%BB%8B%E5%8F%8A%E7%94%A8%E6%B3%95/">Ansible簡介及用法</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../%E9%81%8B%E7%B6%AD%E7%9F%A5%E8%AD%98/">運維知識</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator%E4%BB%8B%E7%B4%B9/">operator介紹</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ocp%E5%91%BD%E4%BB%A4/">ocp命令</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ocp-prot%E4%BB%8B%E7%B4%B9/">ocp-prot介紹</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Darren</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Linux 容器筆記</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="linux">Linux 容器與虛擬化相關技術筆記</h1>
<h2 id="linux-namespace-cgroups">一、Linux 使用 Namespace 隔離與 cgroups 限制做資源管理</h2>
<h3 id="namespace">Namespace（命名空間）</h3>
<ul>
<li>提供資源的「視角<strong>隔離</strong>」，讓每個容器或程序有獨立的資源觀察範圍，如獨立的進程號（PID）、網路介面（NET）、掛載點（MNT）等，互相隔離看不到對方。</li>
</ul>
<h3 id="cgroups">cgroups（控制群組）</h3>
<ul>
<li>用於<strong>限制</strong>和管理系統資源（CPU、記憶體、磁碟 I/O 等）使用量，確保容器或程序不會占用超過配置的資源，避免單一容器資源暴走影響整體系統。</li>
</ul>
<h2 id="vm">二、VM（虛擬機）與容器差異</h2>
<table>
<thead>
<tr>
<th>項目</th>
<th>VM (虛擬機)</th>
<th>容器</th>
</tr>
</thead>
<tbody>
<tr>
<td>核心概念</td>
<td><strong>模擬完整硬體環境</strong>，包含 CPU、記憶體等</td>
<td><strong>共用宿主機 OS 核心</strong>，只隔離使用者空間與資源</td>
</tr>
<tr>
<td>系統組成</td>
<td>完整客戶作業系統（含 Kernel）</td>
<td>只有使用者空間，Kernel 與宿主共用</td>
</tr>
<tr>
<td>安全性</td>
<td><strong>高</strong>，因獨立 Kernel</td>
<td>較<strong>低</strong>，Kernel 漏洞可能導致容器逃逸</td>
</tr>
<tr>
<td>資源消耗</td>
<td>大</td>
<td>輕量，快速啟動</td>
</tr>
<tr>
<td><strong>root 權限影響</strong></td>
<td>容器 <strong>內 root 影響限於 VM</strong></td>
<td>容器內 <strong>root 權限可能直接危害宿主機安全</strong></td>
</tr>
</tbody>
</table>
<h2 id="docker-podman">三、Docker 與 Podman 差異</h2>
<table>
<thead>
<tr>
<th>項目</th>
<th>Docker</th>
<th>Podman</th>
</tr>
</thead>
<tbody>
<tr>
<td>架構</td>
<td>有常駐守護進程（dockerd）</td>
<td>無守護進程，daemonless</td>
</tr>
<tr>
<td>容器管理</td>
<td>透過 dockerd 管理容器</td>
<td>每個容器獨立運行</td>
</tr>
<tr>
<td>預設權限</td>
<td>預設以 root 身份執行</td>
<td>支援 rootless 模式</td>
</tr>
<tr>
<td>重啟機制</td>
<td>支援 --restart 自動重啟</td>
<td>有預設守護進程可以開啟podman-restart.service ，也可以另外搭配 systemd restart</td>
</tr>
<tr>
<td>安全性</td>
<td>root 權限較高</td>
<td>rootless 減少攻擊面，較安全</td>
</tr>
</tbody>
</table>
<h2 id="docker-podman_1">四、Docker 與 Podman 容器重啟差異</h2>
<ul>
<li><strong>Docker</strong>：守護進程 dockerd 支援 <code>--restart</code> 參數，daemon 重啟或宿主機重啟會自動重啟容器。</li>
<li><strong>Podman</strong>：可以開啟podman-restart.service 。或是可用 <code>podman generate systemd</code> 生成 systemd 服務單元，交由 systemd 管理。
<img alt="podman-restart.service" src="../image/docker/podman-restart-service.png" title="podman-restart.service" /></li>
</ul>
<h2 id="kubernetesk8s-root-user-namespace">五、Kubernetes（K8s）中 Root 權限與 User Namespace 隔離</h2>
<ul>
<li>預設容器以 root 身份運行，風險較高。</li>
<li>K8s 1.33 起，預設啟用 User Namespace 隔離（<code>hostUsers: false</code>），將容器 root UID 映射成宿主機非 root 用戶，降低風險。</li>
<li>需 Linux Kernel ≥6.3，容器 runtime 與檔案系統支援。</li>
</ul>
<p>Reference:<br />
<a href="https://www.cncf.io/blog/2025/07/16/securing-kubernetes-1-33-pods-the-impact-of-user-namespace-isolation/">Securing Kubernetes 1.33 Pods: The Impact of User Namespace Isolation</a></p>
<hr />
<h2 id="_1">總結</h2>
<table>
<thead>
<tr>
<th>主題</th>
<th>核心重點</th>
</tr>
</thead>
<tbody>
<tr>
<td>Namespace + cgroups</td>
<td>Namespace 隔離資源視角，cgroups 限制資源量</td>
</tr>
<tr>
<td>VM vs 容器</td>
<td>VM 獨立 kernel 高安全但重資源，容器輕量但風險高</td>
</tr>
<tr>
<td>Docker vs Podman</td>
<td>Docker 有守護進程，Podman 無守護進程且支援 rootless</td>
</tr>
<tr>
<td>容器重啟</td>
<td>Docker 支援自動重啟，Podman 要開啟podman-restart.service或systemd 管理</td>
</tr>
<tr>
<td>K8s rootless</td>
<td>1.33 版起預設 User Namespace 隔離降低 root 風險</td>
</tr>
<tr>
<td>Podman 與 systemd / Quadlet</td>
<td>systemd 管理生命週期，Quadlet 用 YAML 簡化配置</td>
</tr>
</tbody>
</table>
<h2 id="docker-overlay">六 Docker Overlay 網路完整筆記</h2>
<h2 id="overlay">一、Overlay 是什麼</h2>
<p>Overlay 是 Docker 或 Kubernetes 用來讓「不同主機的容器能互通」的虛擬網路。<br />
它會在多台主機之間建立 VXLAN（或 Geneve）隧道，把容器封包封起來再送到對方主機，<br />
讓不同主機的容器看起來像在同一個內網。</p>
<hr />
<h2 id="ip">二、容器內的網路介面與 IP</h2>
<p>在 Overlay 網路中，每個容器通常會有兩張虛擬網卡（eth0、eth1）：</p>
<table>
<thead>
<tr>
<th>介面名稱</th>
<th>網段範例</th>
<th>來源網路</th>
<th>功能說明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>eth0</strong></td>
<td>10.0.x.x</td>
<td>overlay（如 elk-net）</td>
<td>用於跨主機容器之間的內部通訊</td>
</tr>
<tr>
<td><strong>eth1</strong></td>
<td>172.18.x.x</td>
<td>docker_gwbridge</td>
<td>用於對外連線（上網或與主機互通）</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="overlay-bridge">三、Overlay 與 Bridge 的差別與關係</h2>
<table>
<thead>
<tr>
<th>類型</th>
<th>範圍</th>
<th>功能</th>
<th>是否跨主機</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Bridge</strong></td>
<td>單一主機</td>
<td>容器共享主機的虛擬交換器（docker0）</td>
<td>否</td>
</tr>
<tr>
<td><strong>Overlay</strong></td>
<td>多主機</td>
<td>建立跨主機虛擬網路（VXLAN 封裝）</td>
<td>是</td>
</tr>
<tr>
<td><strong>docker_gwbridge</strong></td>
<td>單一主機出口</td>
<td>讓 overlay 容器能連外</td>
<td>否</td>
</tr>
</tbody>
</table>
<p><strong>重點：</strong>
- Overlay：負責「容器 ↔ 容器（跨主機）」的內部封包。<br />
- Bridge / gwbridge：負責「容器 ↔ 外部世界」的出口封包。</p>
<hr />
<h2 id="_2">四、封包實際路徑解析</h2>
<h3 id="1">1️⃣ 容器與容器之間（跨主機）</h3>
<p>[容器A eth0:10.0.2.8]<br />
↓<br />
Overlay VXLAN 封裝 (eth0)<br />
↓<br />
[Node1 實體網卡]<br />
↓<br />
[Node2 實體網卡]<br />
↓<br />
Overlay VXLAN 解封<br />
↓<br />
[容器B eth0:10.0.2.9]</p>
<p>此時封包只在 overlay 網路內部傳遞，不會經過外部網路。</p>
<hr />
<h3 id="2">2️⃣ 容器對外連線（上網或連主機）</h3>
<p>[容器 eth1:172.18.0.3]<br />
↓<br />
docker_gwbridge（主機內 bridge）<br />
↓<br />
主機實體網卡 (eth0)<br />
↓<br />
外部網路 / Internet</p>
<hr />
<h2 id="_3">、整體結構示意圖</h2>
<pre><code>Overlay Network (VXLAN)
┌────────────────────────────────────────────┐
│                10.0.2.0/24                │
│                                            │
│ [Node1]                           [Node2]  │
│  ┌────────────────┐          ┌────────────────┐
│  │容器A eth0→10.0.2.8 ─── eth0←10.0.2.9 容器B│
│  │容器A eth1→172.18.0.3  eth1→172.18.0.4 容器B│
│  └────────────────┘          └────────────────┘
│         │                           │
│   docker_gwbridge            docker_gwbridge
│         │                           │
│      主機網卡                    主機網卡
│         │                           │
└─────────┴────────────── Internet ─────┘
</code></pre>
<hr />
<h2 id="_4">六、口語化理解</h2>
<ul>
<li>每台主機像一棟大樓，裡面的容器用 bridge 互通（同棟樓住戶）。  </li>
<li>Overlay 就像在不同大樓之間拉光纖（VXLAN），讓住戶能跨樓通話。  </li>
<li>docker_gwbridge 是大樓的網路出口，讓人能上網或打外線電話。</li>
</ul>
<hr />
<h2 id="_5">七、重點整理</h2>
<ol>
<li>Overlay：讓容器跨主機互通。  </li>
<li>gwbridge：讓 overlay 容器能連外。  </li>
<li>容器同時會有兩張網卡：  </li>
<li><code>eth0</code> → Overlay（內部互通）  </li>
<li><code>eth1</code> → gwbridge（外部連線）  </li>
<li>Overlay 是內部虛擬網路，不代表能直接上網，<br />
   要連外需透過 bridge（docker_gwbridge）出口。</li>
</ol>
<pre><code></code></pre>
<p>bridge：同主機容器互通<br />
overlay：跨主機容器互通<br />
docker_gwbridge：容器對外通訊出口
```</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../note/" class="btn btn-neutral float-left" title="使用 MkDocs 建立文件網站教學筆記"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../docker_commands/" class="btn btn-neutral float-right" title="Docker常用命令">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../note/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../docker_commands/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
